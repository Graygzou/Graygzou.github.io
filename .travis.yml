  dist: xenial   # required for Python >= 3.7
  language: ruby
  rvm:
  - 2.6.3
  sudo: false # route your build to the container-based infrastructure for a faster build

  addons:
    chrome: stable # make sure you have Chrome available
    apt:
      packages:
        - libcurl4-openssl-dev

  # blocklist
  branches:
    except:
      - master

  # reduce log clutter
  cache: bundler  # caching bundler gem packages will speed up build

  env:
    global:
      - NOKOGIRI_USE_SYSTEM_LIBRARIES=true # speeds up installation of html-proofer

  # pip install -r requirements.txt => command to install dependencies
  # This was obtained by running $pip freeze > requirements.txt
  before_install:
    - gem install bundler

  install:
    - (cd jekyll && gem update bundler)
    - (cd jekyll && bundle check || bundle install)

  before_script:
    - chmod +x scripts/*/*.sh
    - git log --name-only -n 1 HEAD~1..HEAD --pretty=format:%b > last-commit.txt

  stages:
    - name: generation
      if: branch = develop
    - name: build
      if: branch = develop OR branch = release
    - name: integration
      if: branch = release
    - name: validation
      if: branch = release
    - name: deploy
      if: branch = release AND TRAVIS_PULL_REQUEST = false

  matrix:
    allow_failures:
      - if: branch = develop

  jobs:
    include:
      # Stage 1 ==============================
      - stage: "Generation"
        name: "webp images creation"
        script: ./scripts/generation/webp.sh
      - name: "ImageMagick Resizing"
        script: ./scripts/generation/resize-img.sh
      - name: "markdown creation"
        language: python
        python: 3.7
        script: ./scripts/generation/generate-markdown.sh ${GITHUB_API_TOKEN}
      - name: "svg creation"
        language: python
        python: 3.7
        script: ./scripts/generation/group-svg.sh
      # Stage 2 ==============================
      - stage: build
        name: "jekyll production build"
        script: ./scripts/build/build.sh
      # Stage 3 ==============================
      - stage: integration
        name: "pngquant: PNG Compression"
        script: ./scripts/integration/pngquant-compression.sh
      - name: "guetzli: JPG Compression"
        script: ./scripts/integration/guetzli-compression.sh
      # Stage 4 ==============================
      - stage: validation
        name: "Lighthouse CI"
        language: node_js
        node_js: 12 # we stick with a previous version to make lighthouse cli works.
        script: ./scripts/validation/lighthouse-ci.sh
      - name: "Grammar Bot"
        script: ./scripts/validation/grammar-bot.sh
      # Stage 5 ==============================
      - stage: deploy
        name: "Deploy"
        script: ./scripts/deploy/deploy.sh

  # Stage 5 ==============================
  deploy:
    provider: pages
    verbose: true
    local_dir: ./jekyll/site
    skip_cleanup: true
    github_token: ${GITHUB_DEPLOY_TOKEN}  # Set in the settings page of your repository, as a secure variable
    keep_history: true
    target_branch: master
    email: ${GITHUB_BOT_MAIL}
    name: ${GITHUB_BOT_NAME}
    on:
      branch: release

  after_failure:
    - curl https://www.teleconsole.com/get.sh | sh
    - teleconsole

  # See travis job cycle: https://docs.travis-ci.com/user/job-lifecycle
